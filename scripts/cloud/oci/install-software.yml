- hosts: linux_hosts
  become: true
  vars:
    content_dir: "/var/flowlogix"
    etc_conf_d: "{{ content_dir }}/etc/httpd/conf.d"
    os_etc_conf_d: "/etc/httpd/conf.d"
  tasks:
    - name: Install Apache Web Server
      package:
        name: 'httpd'
        state: latest
        update_cache: yes

    - name: Install Apache Mod_SSL
      package:
        name: 'mod_ssl'
        state: latest
        update_cache: yes

    - name: Enable and Start Apache Web Server
      service:
        name: 'httpd.service'
        enabled: true
        state: started

    - name: Open http(s) ports (firewall)
      firewalld:
        port: "{{ item }}/tcp"
        state: enabled
        immediate: true
        permanent: true
      loop:
        - 80
        - 443

    - name: Enable SeLinux content directory
      command: semanage fcontext -a -t httpd_sys_content_t "{{ content_dir }}(/.*)?"
      changed_when: false
      failed_when: false
      no_log: true
      register: selinux

    - name: Make Content and Config directories
      file:
        path: "{{ item }}"
        owner: "{{ ansible_env.SUDO_USER }}"
        state: directory
      loop:
        - "{{ etc_conf_d }}"
        - "{{ content_dir }}/html"

    - name: Enable own Apache config
      blockinfile:
        path: "{{ os_etc_conf_d }}/flowlogix.conf"
        block: |
          IncludeOptional "{{ etc_conf_d }}/*"
        create: true
      notify: Reload Apache

    - name: Write apache config for docroot
      blockinfile:
        path: "{{ os_etc_conf_d }}/docroot.conf"
        block: |
          DocumentRoot "{{ content_dir }}/html"
          <Directory "{{ content_dir }}/html">
              Options Indexes FollowSymLinks
              AllowOverride All
              Require all granted
          </Directory>
        create: true
      notify: Reload Apache

    - name: Disable self-signed certificates
      lineinfile:
        dest: "{{ os_etc_conf_d }}/ssl.conf"
        regexp: '(?i)^(SSLCertificate(Key)?File.*)'
        line: '# Disabled by FlowLogix --- \1'
        backrefs: yes
        state: present
      notify: Reload Apache

    - name: SeLinux fix file permissions
      command: restorecon -Rv "{{ content_dir }}"
      changed_when: false

  handlers:
    - name: Reload Apache
      service:
        name: "httpd.service"
        state: reloaded
