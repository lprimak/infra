- import_playbook: "{{ playbook_dir }}/common/configure-common.yaml"
- hosts: docker:k8s_controllers:k8s_nodes
  become: true
  vars:
    docker_base: https://download.docker.com/linux/centos
    os_version: "{{ ansible_distribution_major_version }}"
    dockerd_args: "{{ dockerd_override_args | default('') }}"

  tasks:
    - name: include vars
      include_vars: "{{ playbook_dir }}/common/config-vars.yaml"
      tags: always

    - name: Add docker repository
      yum_repository:
        name: docker_repo
        description: Docker Repository
        baseurl: "{{ docker_base }}/{{ os_version }}/{{ ansible_architecture }}/stable"

    - name: Verify Docker PGP keys
      rpm_key:
        key: "{{ docker_base }}/gpg"

    - name: Install docker engine
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: latest
        update_cache: yes
      notify:
        - Reload Docker

    - name: Create docker group
      group:
        name: docker
        gid: 900

    - name: Add user to docker group
      user:
        name: "{{ ansible_env.SUDO_USER }}"
        groups: docker
        append: true

    - name: Create docker systemd configuration directory
      file:
        dest: "{{ item }}"
        state: directory
      loop:
        - "/etc/systemd/system/docker.service.d/"
        - "/etc/systemd/system/run-docker-.mount.d"
      tags: docker_config

    - name: Create docker configuration directory
      file:
        dest: /etc/docker
        state: directory
      tags: docker_config

    - name: Configure Docker (systemd)
      copy:
        dest: /etc/systemd/system/docker.service.d/override.conf
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/dockerd -H fd:// {{ dockerd_args }}
          {% if required_vagrant_mount_paths is defined %}
          ExecStartPre=/bin/sh -c 'for dir in {{ required_vagrant_mount_paths }}; \
          do timeout=120; while [ ! -d "$dir" ]; do sleep 1; timeout=$((timeout-1)); [ $timeout -le 0 ] && exit 1; done; done'
          TimeoutStartSec=600
          {% endif %}
          ExecStartPost=/bin/sh -c "cat /proc/sys/fs/binfmt_misc/status"
          ExecStartPost=/bin/sh -c "systemd-run --on-active=30 /usr/bin/docker run --privileged --rm tonistiigi/binfmt --install all"
          {% if required_vagrant_mount_paths is defined %}
          [Unit]
          RequiresMountsFor={{ required_vagrant_mount_paths }}
          After=vagrant.mount
          [Install]
          WantedBy=multi-user.target
          {% endif %}
      notify:
        - Reload systemd
        - Reload Docker
      tags: docker_config

    - name: Silence mount logs (systemd)
      copy:
        dest: "/etc/systemd/system/run-docker-.mount.d/10-silence.conf"
        content: |
          [Mount]
          LogLevelMax=0
      notify:
        - Reload systemd
        - Reload Docker
      tags: docker_config

    - name: Configure Docker (json)
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "experimental": true,
            "features": {
              "containerd-snapshotter": true
            },
            "registry-mirrors": [
              "https://registry-1.docker.io"
            ]
          }
      notify:
        - Reload systemd
        - Reload Docker
      tags: docker_config

    - name: Enable Docker engine
      service:
        name: 'docker'
        enabled: true

    - name: Disable Docker Socket service
      service:
        name: 'docker.socket'
        enabled: false

    - name: Start Docker engine
      service:
        name: 'docker'
        state: started
      failed_when: false

    - name: Create Jenkins directories
      file:
        dest: var/jenkins
        state: directory
      become: false

  handlers:
    - name: Reload systemd
      systemd_service:
        daemon_reload: true

    - name: Reload Docker
      service:
        name: 'docker'
        state: restarted
      failed_when: false
